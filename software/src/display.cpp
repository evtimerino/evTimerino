#include <display.h>

static const unsigned char timerino_logo_128x64_bitmap[] = {
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xf8,
    0x7f,0x1e,0x00,0x00,0x00,0x00,0x00,0x00,0x78,0x00,0x00,0x00,0x00,0x00,
    0x00,0xf8,0x7f,0x1e,0x00,0x00,0x00,0x00,0x00,0x00,0x78,0x00,0x00,0x00,
    0x00,0x00,0x00,0xf8,0x7f,0x1e,0x00,0x00,0x00,0x00,0x00,0x00,0x78,0x00,
    0x00,0x00,0x00,0x00,0x00,0xf8,0x7f,0x1e,0x00,0x00,0x00,0x00,0x00,0x00,
    0x78,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x07,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x07,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x07,0x9e,
    0xff,0xf9,0x07,0xfe,0xe1,0x7f,0x78,0xfe,0x1f,0xf8,0x07,0x00,0x00,0x80,
    0x07,0x9e,0xff,0xf9,0x07,0xfe,0xe1,0x7f,0x78,0xfe,0x1f,0xf8,0x07,0x00,
    0x00,0x80,0x07,0x9e,0xff,0xff,0x9f,0xff,0xe7,0xff,0x79,0xfe,0x7f,0xfe,
    0x1f,0x00,0x00,0x80,0x07,0x9e,0xff,0xff,0x9f,0xff,0xe7,0xff,0x79,0xfe,
    0x7f,0xfe,0x1f,0x00,0x00,0x80,0x07,0x1e,0x1e,0x1e,0x9e,0x87,0x87,0xe7,
    0x79,0x78,0x78,0x1e,0x1e,0x00,0x00,0x80,0x07,0x1e,0x1e,0x1e,0x9e,0x87,
    0x87,0xe7,0x79,0x78,0x78,0x1e,0x1e,0x00,0x00,0x80,0x07,0x1e,0x1e,0x1e,
    0x9e,0xe7,0x81,0x07,0x78,0x78,0x78,0x1e,0x1e,0x00,0x00,0x80,0x07,0x1e,
    0x1e,0x1e,0x9e,0xe7,0x81,0x07,0x78,0x78,0x78,0x1e,0x1e,0x00,0x00,0x80,
    0x07,0x1e,0x1e,0x1e,0x9e,0xff,0x87,0x07,0x78,0x78,0x78,0xfe,0x1f,0x00,
    0x00,0x80,0x07,0x1e,0x1e,0x1e,0x9e,0xff,0x87,0x07,0x78,0x78,0x78,0xfe,
    0x1f,0x00,0x00,0x80,0x07,0x1e,0x1e,0x1e,0x1e,0xfe,0x87,0x07,0x78,0x78,
    0x78,0xf8,0x07,0x00,0x00,0x80,0x07,0x1e,0x1e,0x1e,0x1e,0xfe,0x87,0x07,
    0x78,0x78,0x78,0xf8,0x07,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x1e,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0xfe,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xe6,0x03,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x06,0x86,0x07,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x07,0x06,0x0e,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x03,
    0x06,0x1c,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x80,0x01,0x06,0x18,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0xc0,0x11,0x06,0x38,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0xc0,0x60,0x00,0x30,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0xc0,0xe0,0x00,0x30,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x60,0xc0,0x03,0x60,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x60,0x80,0x07,0x60,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x60,0x80,
    0x0f,0x60,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x60,0x00,0x0f,0x60,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x60,0x00,0x06,0x60,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x60,0x00,0x00,0x60,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0xc0,0x00,0x00,0x30,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xc0,0x00,0x00,0x30,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xc0,0x01,0x00,0x38,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x01,
    0x00,0x18,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x80,0x03,0x00,0x1c,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x07,0x00,0x0e,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x1e,0x80,0x07,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x7c,0xe0,0x03,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xf0,0xff,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x1f,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00};

static const unsigned char adjust_count_1_18_bits[] = {
    0xfe, 0xff, 0x01, 0xff, 0xff, 0x03, 0x03, 0x00, 0x03, 0x03, 0x00, 0x03,
    0x83, 0x07, 0x03, 0x83, 0x07, 0x03, 0x03, 0x06, 0x03, 0x03, 0x06, 0x03,
    0x03, 0x06, 0x03, 0x03, 0x06, 0x03, 0x03, 0x06, 0x03, 0x03, 0x06, 0x03,
    0x03, 0x06, 0x03, 0x03, 0x06, 0x03, 0x03, 0x00, 0x03, 0x03, 0x00, 0x03,
    0xff, 0xff, 0x03, 0xfe, 0xff, 0x01 };


static const unsigned char adjust_count_2_18_bits[] = {
    0xfe, 0xff, 0x01, 0xff, 0xff, 0x03, 0x03, 0x00, 0x03, 0x03, 0x00, 0x03,
    0xc3, 0x07, 0x03, 0xc3, 0x0f, 0x03, 0x03, 0x0c, 0x03, 0x03, 0x0c, 0x03,
    0x83, 0x0f, 0x03, 0xc3, 0x07, 0x03, 0xc3, 0x00, 0x03, 0xc3, 0x00, 0x03,
    0xc3, 0x0f, 0x03, 0xc3, 0x0f, 0x03, 0x03, 0x00, 0x03, 0x03, 0x00, 0x03,
    0xff, 0xff, 0x03, 0xfe, 0xff, 0x01 };

static const unsigned char adjust_count_3_18_bits[] = {
    0xfe, 0xff, 0x01, 0xff, 0xff, 0x03, 0x03, 0x00, 0x03, 0x03, 0x00, 0x03,
    0xc3, 0x07, 0x03, 0xc3, 0x0f, 0x03, 0x03, 0x0c, 0x03, 0x03, 0x0c, 0x03,
    0x03, 0x0f, 0x03, 0x03, 0x0f, 0x03, 0x03, 0x0c, 0x03, 0x03, 0x0c, 0x03,
    0xc3, 0x0f, 0x03, 0xc3, 0x07, 0x03, 0x03, 0x00, 0x03, 0x03, 0x00, 0x03,
    0xff, 0xff, 0x03, 0xfe, 0xff, 0x01 };


static const unsigned char adjust_count_4_18_bits[] = {
    0xfe, 0xff, 0x01, 0xff, 0xff, 0x03, 0x03, 0x00, 0x03, 0x03, 0x00, 0x03,
    0xc3, 0x0c, 0x03, 0xc3, 0x0c, 0x03, 0xc3, 0x0c, 0x03, 0xc3, 0x0c, 0x03,
    0xc3, 0x0f, 0x03, 0xc3, 0x0f, 0x03, 0x03, 0x0c, 0x03, 0x03, 0x0c, 0x03,
    0x03, 0x0c, 0x03, 0x03, 0x0c, 0x03, 0x03, 0x00, 0x03, 0x03, 0x00, 0x03,
    0xff, 0xff, 0x03, 0xfe, 0xff, 0x01 };

static const unsigned char adjust_count_5_18_bits[] = {
    0xfe, 0xff, 0x01, 0xff, 0xff, 0x03, 0x03, 0x00, 0x03, 0x03, 0x00, 0x03,
    0xc3, 0x0f, 0x03, 0xc3, 0x0f, 0x03, 0xc3, 0x00, 0x03, 0xc3, 0x00, 0x03,
    0xc3, 0x07, 0x03, 0xc3, 0x0f, 0x03, 0x03, 0x0c, 0x03, 0x03, 0x0c, 0x03,
    0xc3, 0x0f, 0x03, 0xc3, 0x07, 0x03, 0x03, 0x00, 0x03, 0x03, 0x00, 0x03,
    0xff, 0xff, 0x03, 0xfe, 0xff, 0x01 };

static const unsigned char adjust_count_6_18_bits[] = {
    0xfe, 0xff, 0x01, 0xff, 0xff, 0x03, 0x03, 0x00, 0x03, 0x03, 0x00, 0x03,
    0x83, 0x0f, 0x03, 0xc3, 0x0f, 0x03, 0xc3, 0x00, 0x03, 0xc3, 0x00, 0x03,
    0xc3, 0x07, 0x03, 0xc3, 0x0f, 0x03, 0xc3, 0x0c, 0x03, 0xc3, 0x0c, 0x03,
    0xc3, 0x0f, 0x03, 0x83, 0x07, 0x03, 0x03, 0x00, 0x03, 0x03, 0x00, 0x03,
    0xff, 0xff, 0x03, 0xfe, 0xff, 0x01 };

static const unsigned char adjust_count_7_18_bits[] = {
    0xfe, 0xff, 0x01, 0xff, 0xff, 0x03, 0x03, 0x00, 0x03, 0x03, 0x00, 0x03,
    0xc3, 0x0f, 0x03, 0xc3, 0x0f, 0x03, 0x03, 0x0c, 0x03, 0x03, 0x06, 0x03,
    0x03, 0x06, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x83, 0x01, 0x03,
    0x83, 0x01, 0x03, 0xc3, 0x00, 0x03, 0x03, 0x00, 0x03, 0x03, 0x00, 0x03,
    0xff, 0xff, 0x03, 0xfe, 0xff, 0x01 };

static const unsigned char adjust_count_8_18_bits[] = {
    0xfe, 0xff, 0x01, 0xff, 0xff, 0x03, 0x03, 0x00, 0x03, 0x03, 0x00, 0x03,
    0x83, 0x07, 0x03, 0xc3, 0x0f, 0x03, 0xc3, 0x0c, 0x03, 0xc3, 0x0c, 0x03,
    0xc3, 0x0f, 0x03, 0xc3, 0x0f, 0x03, 0xc3, 0x0c, 0x03, 0xc3, 0x0c, 0x03,
    0xc3, 0x0f, 0x03, 0x83, 0x07, 0x03, 0x03, 0x00, 0x03, 0x03, 0x00, 0x03,
    0xff, 0xff, 0x03, 0xfe, 0xff, 0x01 };

static const unsigned char adjust_count_9_18_bits[] = {
    0xfe, 0xff, 0x01, 0xff, 0xff, 0x03, 0x03, 0x00, 0x03, 0x03, 0x00, 0x03,
    0x83, 0x07, 0x03, 0xc3, 0x0f, 0x03, 0xc3, 0x0c, 0x03, 0xc3, 0x0c, 0x03,
    0xc3, 0x0f, 0x03, 0x83, 0x0f, 0x03, 0x03, 0x0c, 0x03, 0x03, 0x0c, 0x03,
    0xc3, 0x0f, 0x03, 0xc3, 0x07, 0x03, 0x03, 0x00, 0x03, 0x03, 0x00, 0x03,
    0xff, 0xff, 0x03, 0xfe, 0xff, 0x01 };

static const unsigned char adjust_count_9p_18_bits[] = {
    0xfe, 0xff, 0x01, 0xff, 0xff, 0x03, 0x03, 0x00, 0x03, 0x03, 0x00, 0x03,
    0x03, 0x00, 0x03, 0x73, 0x00, 0x03, 0xfb, 0x18, 0x03, 0xdb, 0x18, 0x03,
    0xfb, 0x7e, 0x03, 0xf3, 0x7e, 0x03, 0xc3, 0x18, 0x03, 0xfb, 0x18, 0x03,
    0x7b, 0x00, 0x03, 0x03, 0x00, 0x03, 0x03, 0x00, 0x03, 0x03, 0x00, 0x03,
    0xff, 0xff, 0x03, 0xfe, 0xff, 0x01 };

Display::Display(U8G2_SSD1309_128X64_NONAME0_F_HW_I2C& o) : oled(o)
{    
    pinMode(SWITCH_PIN, INPUT_PULLUP);
    oled.setFont(u8g2_font_pressstart2p_8r);
}

Display::~Display()
{
}

void Display::drawAdjustment(Adjustment adj, uint16_t timeCounter, uint8_t area, uint8_t value) {
    oled.clearBuffer();
    char s[13];
    switch (adj)
    {
    case Adjustment::DODGE:
        sprintf(s, "DODGE AREA %d", area+1);
        oled.drawStr(0, 64, s);
        break;
    case Adjustment::BURN:
        sprintf(s, "BURN AREA %d", area+1);
        oled.drawStr(0, 64, s);
    default:
        break;
    }

    uint8_t tenth = timeCounter % 10;
    uint8_t seconds = (timeCounter / 10) % 10;
    uint8_t tenSeconds = (timeCounter / 100) % 10;
    uint8_t hundredSeconds = (timeCounter / 1000) % 10;

    drawDigit(102, 0, tenth);
    if (timeCounter <= 9) drawDigit(66, 0, 0);
    if (timeCounter > 9) drawDigit(66, 0, seconds);
    if (timeCounter > 99) drawDigit(34, 0, tenSeconds);
    if (timeCounter > 999) drawDigit(2, 0, hundredSeconds);
    oled.drawBox(95, 0 + 39, 4, 4);
    
    int8_t adj_value = value;
    if (value < 0) adj_value = value * -1;
    uint8_t digit = adj_value % 10;
    uint8_t double_digit = (adj_value / 10) % 10;
    drawSmallDigit(119, 47, digit);
    if (value > 9) drawSmallDigit(105, 47, double_digit);
    oled.sendBuffer();
}


void Display::drawNewAdjustment(uint16_t timeCounter, int8_t value, Adjustment type, uint8_t number) {
    oled.clearBuffer();
    char s[13];
    number++;
    switch (type)
    {
    case Adjustment::NONE: 
        sprintf(s, "NEW ADJ %d", number);
        oled.drawStr(0, 64, s);
        break;
    case Adjustment::DODGE:
        sprintf(s, "DODGE ADJ");
        oled.drawStr(0, 64, s);
        break;
    case Adjustment::BURN:
        sprintf(s, "BURN ADJ");
        oled.drawStr(0, 64, s);
        break;
    default:
        break;
    }

    uint8_t tenth = timeCounter % 10;
    uint8_t seconds = (timeCounter / 10) % 10;
    uint8_t tenSeconds = (timeCounter / 100) % 10;
    uint8_t hundredSeconds = (timeCounter / 1000) % 10;

    drawDigit(102, 0, tenth);
    if (timeCounter <= 9) drawDigit(66, 0, 0);
    if (timeCounter > 9) drawDigit(66, 0, seconds);
    if (timeCounter > 99) drawDigit(34, 0, tenSeconds);
    if (timeCounter > 999) drawDigit(2, 0, hundredSeconds);
    oled.drawBox(95, 0 + 39, 4, 4);

    int8_t adj_value = value;
    if ( value < 0) adj_value = value * -1;
    uint8_t digit = adj_value % 10;
    uint8_t double_digit = (adj_value / 10) % 10;
    drawSmallDigit(119, 47, digit);
    if (value > 9) drawSmallDigit(105, 47, double_digit);
    oled.sendBuffer();
}


void Display::drawMain(uint16_t timeCounter, uint8_t precision, uint8_t dodgeCount, uint8_t burnCount, bool prepare) {
    oled.clearBuffer();

    if (prepare) {
        oled.setFont(u8g2_font_open_iconic_play_2x_t);
        oled.drawGlyph(60, 64, 68);
        oled.setFont(u8g2_font_pressstart2p_8r);
    }

    if (dodgeCount > 0) drawAdj(0, 46, dodgeCount);
    if (burnCount > 0) drawAdj(30, 46, burnCount);

    uint8_t tenth = timeCounter % 10;
    uint8_t seconds = (timeCounter / 10) % 10;
    uint8_t tenSeconds = (timeCounter / 100) % 10;
    uint8_t hundredSeconds = (timeCounter / 1000) % 10;

    uint8_t digit = precision % 10;
    uint8_t double_digit = (precision / 10) % 10;

    drawDigit(102, 0, tenth);
    if (timeCounter <= 9) drawDigit(66, 0, 0);
    if (timeCounter > 9) drawDigit(66, 0, seconds);
    if (timeCounter > 99) drawDigit(34, 0, tenSeconds);
    if (timeCounter > 999) drawDigit(2, 0, hundredSeconds);
    oled.drawBox(95, 0 + 39, 4, 4);
    
    drawSmallDigit(119, 47, digit);
    if (precision > 9) drawSmallDigit(105, 47, double_digit);

    oled.sendBuffer();
    
}

void Display::drawTestStrip(Teststrip mode, uint16_t timeCounter, uint8_t testStripIdx) {
    oled.clearBuffer();
    switch (mode)
    {
    case Teststrip::SEPARATE:
        oled.drawStr(0, 64, "SEPARATE TS");
        break;
    case Teststrip::SPLIT_GRADE:
        oled.drawStr(0, 64, "SPLIT TS");
        break;
    case Teststrip::INCREMENTAL:
        oled.drawStr(0, 64, "INCREMENTAL TS");
        break;
    default:
        break;
    }
    uint8_t tenth = timeCounter % 10;
    uint8_t seconds = (timeCounter / 10) % 10;
    uint8_t tenSeconds = (timeCounter / 100) % 10;
    uint8_t hundredSeconds = (timeCounter / 1000) % 10;

    uint8_t digit = testStripIdx % 10;
    uint8_t double_digit = (testStripIdx / 10) % 10;

    drawDigit(102, 0, tenth);
    if (timeCounter <= 9) drawDigit(66, 0, 0);
    if (timeCounter > 9) drawDigit(66, 0, seconds);
    if (timeCounter > 99) drawDigit(34, 0, tenSeconds);
    if (timeCounter > 999) drawDigit(2, 0, hundredSeconds);
    oled.drawBox(95, 0 + 39, 4, 4);
    
    drawSmallDigit(119, 47, digit);
    if (testStripIdx > 9) drawSmallDigit(105, 47, double_digit);
    
    oled.sendBuffer();
}


void Display::drawTestStripSplitGrade(uint16_t timeCounter, uint8_t testStripIdx) {
    oled.clearBuffer();
    oled.drawStr(0, 65, "SG TS");
    uint8_t tenth = timeCounter % 10;
    uint8_t seconds = (timeCounter / 10) % 10;
    uint8_t tenSeconds = (timeCounter / 100) % 10;
    uint8_t hundredSeconds = (timeCounter / 1000) % 10;

    uint8_t digit = testStripIdx % 10;
    uint8_t double_digit = (testStripIdx / 10) % 10;

    drawDigit(102, 0, tenth);
    if (timeCounter <= 9) drawDigit(66, 0, 0);
    if (timeCounter > 9) drawDigit(66, 0, seconds);
    if (timeCounter > 99) drawDigit(34, 0, tenSeconds);
    if (timeCounter > 999) drawDigit(2, 0, hundredSeconds);
    oled.drawBox(95, 0 + 39, 4, 4);
    
    drawSmallDigit(119, 47, digit);
    if (testStripIdx > 9) drawSmallDigit(105, 47, double_digit);

    oled.sendBuffer();
}

void Display::drawExposure(uint16_t timeCounter) {
    oled.clearBuffer();
    oled.drawStr(0, 64, "EXPOSURE");
    uint8_t tenth = timeCounter % 10;
    uint8_t seconds = (timeCounter / 10) % 10;
    uint8_t tenSeconds = (timeCounter / 100) % 10;
    uint8_t hundredSeconds = (timeCounter / 1000) % 10;
    drawDigit(102, 0, tenth);
    if (timeCounter <= 9) drawDigit(66, 0, 0);
    if (timeCounter > 9) drawDigit(66, 0, seconds);
    if (timeCounter > 99) drawDigit(34, 0, tenSeconds);
    if (timeCounter > 999) drawDigit(2, 0, hundredSeconds);
        oled.drawBox(95, 0 + 39, 4, 4);
    oled.sendBuffer();
}

void Display::drawPrecision(uint8_t precision) {   
    oled.clearBuffer();
    oled.drawStr(0, 64, "PRECISION");
    uint8_t digit = precision % 10;
    uint8_t double_digit = (precision / 10) % 10;
    drawDigit(102, 0, digit);
    if (precision > 9) drawDigit(66, 0, double_digit);
    oled.sendBuffer();
}

void Display::drawFocus() {
    oled.clearBuffer();
    oled.drawStr(0, 64, "FOCUS");
    oled.setFont(u8g2_font_open_iconic_thing_4x_t);
    oled.drawGlyph(50, 40, 78);
    oled.setFont(u8g2_font_pressstart2p_8r);
        
    oled.sendBuffer();
}

void Display::drawPrepare() {
    oled.clearBuffer();
    oled.drawStr(0, 64, "PREPARE");
    oled.setFont(u8g2_font_open_iconic_play_4x_t);
    oled.drawGlyph(50, 40, 68);
    oled.setFont(u8g2_font_pressstart2p_8r);
    oled.sendBuffer();
}

void Display::drawPause() {
    oled.clearBuffer();
    oled.drawStr(0, 64, "PAUSE");
    oled.setFont(u8g2_font_open_iconic_play_4x_t);
    oled.drawGlyph(50, 40, 68);
    oled.setFont(u8g2_font_pressstart2p_8r);
    oled.sendBuffer();
}


void Display::drawMetronome(uint16_t timeCounter) {
    oled.clearBuffer();
    oled.drawStr(0, 64, "METRONOME");
    uint8_t tenth = timeCounter % 10;
    uint8_t seconds = (timeCounter / 10) % 10;
    uint8_t tenSeconds = (timeCounter / 100) % 10;
    uint8_t hundredSeconds = (timeCounter / 1000) % 10;
    drawDigit(102, 0, tenth);
    if (timeCounter <= 9) drawDigit(66, 0, 0);
    if (timeCounter > 9) drawDigit(66, 0, seconds);
    if (timeCounter > 99) drawDigit(34, 0, tenSeconds);
    if (timeCounter > 999) drawDigit(2, 0, hundredSeconds);
        oled.drawBox(95, 0 + 39, 4, 4);
    oled.sendBuffer();
}

void Display::drawAdj(uint8_t x, uint8_t y, uint8_t value) {
    switch (value)
    {
    case 1:
        oled.drawXBM(x, y, 18, 18, adjust_count_1_18_bits);
        break;
    case 2:
        oled.drawXBM(x, y, 18, 18, adjust_count_2_18_bits);
        break;
    case 3:
        oled.drawXBM(x, y, 18, 18, adjust_count_3_18_bits);
        break;
    case 4:
        oled.drawXBM(x, y, 18, 18, adjust_count_4_18_bits);
        break;
    case 5:
        oled.drawXBM(x, y, 18, 18, adjust_count_5_18_bits);
        break;
    case 6:
        oled.drawXBM(x, y, 18, 18, adjust_count_6_18_bits);
        break;
    case 7:
        oled.drawXBM(x, y, 18, 18, adjust_count_7_18_bits);
        break;
    case 8:
        oled.drawXBM(x, y, 18, 18, adjust_count_8_18_bits);
        break;
    case 9:
        oled.drawXBM(x, y, 18, 18, adjust_count_9_18_bits);
        break;
    default:
        oled.drawXBM(x, y, 18, 18, adjust_count_9p_18_bits);
        break;
    }
}

void Display::drawDigit(uint8_t x, uint8_t y, uint8_t digit) {
    int segments = segDigit[digit];
    if ((segments & SegA) != 0) {
        oled.drawLine(x + 1, y + 0, x + 24, y + 0);
        oled.drawLine(x + 2, y + 1, x + 23, y + 1);
        oled.drawLine(x + 3, y + 2, x + 22, y + 2);
        oled.drawLine(x + 4, y + 3, x + 21, y + 3);
        oled.drawLine(x + 5, y + 4, x + 20, y + 4);
    }
    if ((segments & SegB) != 0) {
        oled.drawLine(x + 21, y + 5, x + 21, y + 18);
        oled.drawLine(x + 22, y + 4, x + 22, y + 19);
        oled.drawLine(x + 23, y + 3, x + 23, y + 20);
        oled.drawLine(x + 24, y + 2, x + 24, y + 19);
        oled.drawLine(x + 25, y + 1, x + 25, y + 18);
    }
    if ((segments & SegC) != 0) {
        oled.drawLine(x + 21, y + 24, x + 21, y + 37);
        oled.drawLine(x + 22, y + 23, x + 22, y + 38);
        oled.drawLine(x + 23, y + 22, x + 23, y + 39);
        oled.drawLine(x + 24, y + 23, x + 24, y + 40);
        oled.drawLine(x + 25, y + 24, x + 25, y + 41);
    }
    if ((segments & SegD) != 0) {
        oled.drawLine(x + 5, y + 38, x + 20, y + 38);
        oled.drawLine(x + 4, y + 39, x + 21, y + 39);
        oled.drawLine(x + 3, y + 40, x + 22, y + 40);
        oled.drawLine(x + 2, y + 41, x + 23, y + 41);
        oled.drawLine(x + 1, y + 42, x + 24, y + 42);
    }
    if ((segments & SegE) != 0) {
        oled.drawLine(x + 0, y + 24, x + 0, y + 41);
        oled.drawLine(x + 1, y + 23, x + 1, y + 40);
        oled.drawLine(x + 2, y + 22, x + 2, y + 39);
        oled.drawLine(x + 3, y + 23, x + 3, y + 38);
        oled.drawLine(x + 4, y + 24, x + 4, y + 37);
    }
    if ((segments & SegF) != 0) {
        oled.drawLine(x + 0, y + 1, x + 0, y + 18);
        oled.drawLine(x + 1, y + 2, x + 1, y + 19);
        oled.drawLine(x + 2, y + 3, x + 2, y + 20);
        oled.drawLine(x + 3, y + 4, x + 3, y + 19);
        oled.drawLine(x + 4, y + 5, x + 4, y + 18);
    }
    if ((segments & SegG) != 0) {
        oled.drawLine(x + 5, y + 19, x + 20, y + 19);
        oled.drawLine(x + 4, y + 20, x + 21, y + 20);
        oled.drawLine(x + 3, y + 21, x + 22, y + 21);
        oled.drawLine(x + 4, y + 22, x + 21, y + 22);
        oled.drawLine(x + 5, y + 23, x + 20, y + 23);
    }
}

void Display::drawSmallDigit(uint8_t x, uint8_t y, uint8_t digit) {
    int segments = segDigit[digit];
    if ((segments & SegA) != 0) {
        oled.drawLine(x + 1, y + 0, x + 7, y + 0);
        oled.drawLine(x + 2, y + 1, x + 6, y + 1);
    }
    if ((segments & SegB) != 0) {
        oled.drawLine(x + 7, y + 2, x + 7, y + 6);
        oled.drawLine(x + 8, y + 1, x + 8, y + 7);
    }
    if ((segments & SegC) != 0) {
        oled.drawLine(x + 7, y + 10, x + 7, y + 14);
        oled.drawLine(x + 8, y + 9, x + 8, y + 15);
    }
    if ((segments & SegD) != 0) {
        oled.drawLine(x + 2, y + 15, x + 6, y + 15);
        oled.drawLine(x + 1, y + 16, x + 7, y + 16);
    }
    if ((segments & SegE) != 0) {
        oled.drawLine(x + 0, y + 9, x + 0, y + 15);
        oled.drawLine(x + 1, y + 10, x + 1, y + 14);
    }
    if ((segments & SegF) != 0) {
        oled.drawLine(x + 0, y + 1, x + 0, y + 7);
        oled.drawLine(x + 1, y + 2, x + 1, y + 6);
    }
    if ((segments & SegG) != 0) {
        oled.drawLine(x + 2, y + 7, x + 6, y + 7);
        oled.drawLine(x + 1, y + 8, x + 7, y + 8);
        oled.drawLine(x + 2, y + 9, x + 6, y + 9);
    }
}

void Display::drawSign(uint8_t x, uint8_t y, bool positive) {
    if (positive) {
        oled.drawLine(x + 3, y + 0, x + 3, y + 7);
        oled.drawLine(x + 4, y + 0, x + 4, y + 7);
    }
    oled.drawLine(x, y + 3, x + 7, y + 3);
    oled.drawLine(x, y + 4, x + 7, y + 4);
}

void Display::powerSave(bool activate) {
    if (!powerSaveState && activate) {
        oled.setPowerSave(1);
        powerSaveState = true;
        return;
    }
    if (powerSaveState && activate) {
        oled.setPowerSave(0);
        powerSaveState = false;
    }
}

void Display::clearDisplay() {
    oled.clearDisplay();
}

void Display::menuSelectionUp() {
    menuSelection++;
}

void Display::menuSelectionDown() {
    menuSelection--;
}

void Display::drawLogo() {
    oled.clearBuffer();
    oled.setFontMode(1);
    oled.setBitmapMode(1);
    oled.drawXBM(0, 0, 128, 64, timerino_logo_128x64_bitmap);
    oled.sendBuffer();
}

void Display::updateBrightness(uint8_t level) {
    switch (level)
    {
    case 1:
        setSSD1309VcomDeselect(0);
        setSSD1309PreChargePeriod(1, 1);
        break;
    case 2:
        setSSD1309VcomDeselect(2);
        setSSD1309PreChargePeriod(4, 4);
        break;
    case 3:
        setSSD1309VcomDeselect(4);
        setSSD1309PreChargePeriod(6, 6);
        break;
    case 4:
        setSSD1309VcomDeselect(7);
        setSSD1309PreChargePeriod(15, 15);
        break;
    default:
        break;
    }
    brightnessLevel = level;
}

void Display::setSSD1309VcomDeselect(uint8_t v)
{	
  u8x8_cad_StartTransfer(oled.getU8x8());
  u8x8_cad_SendCmd(oled.getU8x8(), 0x0db);
  u8x8_cad_SendArg(oled.getU8x8(), v << 4);
  u8x8_cad_EndTransfer(oled.getU8x8());
}

void Display::setSSD1309PreChargePeriod(uint8_t p1, uint8_t p2)
{	
  u8x8_cad_StartTransfer(oled.getU8x8());
  u8x8_cad_SendCmd(oled.getU8x8(), 0x0d9);
  u8x8_cad_SendArg(oled.getU8x8(), (p2 << 4) | p1 );
  u8x8_cad_EndTransfer(oled.getU8x8());
}

uint8_t Display::getBrightnessLevel() {
    return brightnessLevel;
}